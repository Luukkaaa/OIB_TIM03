import React, { useEffect, useMemo, useState } from "react";















import { IUserAPI } from "../../../api/users/IUserAPI";















import { UserDTO } from "../../../models/users/UserDTO";















import { useAuth } from "../../../hooks/useAuthHook";















import { UserFormModal } from "./UserFormModal";















import { UserRole } from "../../../enums/UserRole";















import "./UserManagement.css";































type Props = {















  userAPI: IUserAPI;















};































export const UserManagement: React.FC<Props> = ({ userAPI }) => {















  const { token } = useAuth();















  const [users, setUsers] = useState<UserDTO[]>([]);















  const [loading, setLoading] = useState(false);















  const [error, setError] = useState<string | null>(null);















  const [search, setSearch] = useState("");















  const [modalOpen, setModalOpen] = useState(false);















  const [editUser, setEditUser] = useState<UserDTO | null>(null);































  const hasToken = useMemo(() => !!token, [token]);































  useEffect(() => {















    if (hasToken) {















      void loadUsers();















    }















  }, [hasToken]);































  const loadUsers = async () => {















    if (!token) return;















    setLoading(true);















    setError(null);















    try {















      const data = await userAPI.getAllUsers(token);















      setUsers(data);















    } catch (err: any) {















      setError(















        err?.response?.data?.message || "Неуспешно учитавање корисника."















      );















    } finally {















      setLoading(false);















    }















  };































  const handleSearch = async () => {















    if (!token) return;















    const trimmed = search.trim();















    if (!trimmed) {















      await loadUsers();















      return;















    }















    if (trimmed.length < 2) {















      setError("Unesite najmanje 2 znaka za pretragu.");















      return;















    }















    setLoading(true);















    setError(null);















    try {















      const data = await userAPI.searchUsers(token, trimmed);















      setUsers(data);















    } catch (err: any) {















      setError(err?.response?.data?.message || "Greska pri pretrazi korisnika.");















    } finally {















      setLoading(false);















    }















  };































  const handleCreate = () => {















    setEditUser(null);















    setModalOpen(true);















  };































  const handleEdit = (u: UserDTO) => {















    setEditUser(u);















    setModalOpen(true);















  };































  const handleDelete = async (id: number) => {















    if (!token) return;















    const confirmed = window.confirm("Обриши корисника?");















    if (!confirmed) return;















    setLoading(true);















    setError(null);















    try {















      await userAPI.deleteUser(token, id);















      await loadUsers();















    } catch (err: any) {















      setError(err?.response?.data?.message || "Брисање није успело.");















    } finally {















      setLoading(false);















    }















  };































  const handleSubmit = async (payload: any) => {















    if (!token) return;















    setLoading(true);















    setError(null);















    try {















      if (editUser) {















        await userAPI.updateUser(token, editUser.id, payload);















      } else {















        await userAPI.createUser(token, payload);















      }















      setModalOpen(false);















      setEditUser(null);















      await loadUsers();







      window.dispatchEvent(new CustomEvent("user-updated"));















    } catch (err: any) {















      setError(err?.response?.data?.message || "Чување није успело.");















    } finally {















      setLoading(false);















    }















  };































  const roleBadge = (role: string) => {















    const normalized = role.toUpperCase();















    if (normalized === UserRole.ADMIN) {















      return <span className="role-badge role-admin">Админ</span>;















    }















    if (normalized === UserRole.SALES_MANAGER) {















      return <span className="role-badge role-manager">Менаџер продаје</span>;















    }















    return <span className="role-badge role-seller">Продавац</span>;















  };































  return (















    <section className="card user-card">















      <header className="user-toolbar">















        <div>















          <h3 className="section-title">Корисници</h3>















          <p className="text-muted">Преглед, претрага и управљање налозима.</p>















        </div>















        <button className="btn btn-accent" onClick={handleCreate}>















          + Нови корисник















        </button>















      </header>































      {error && <div className="alert alert-error">{error}</div>}































      <div className="user-toolbar">















        <div className="form-group">















          <label className="sr-only" htmlFor="user-search">















            Претрага корисника















          </label>















          <input







            id="user-search"







            className="auth-input"







            placeholder="Претрага корисника"







            value={search}







            onChange={(e) => {







              setSearch(e.target.value);







              setError(null);







            }}







            onKeyDown={(e) => {















              if (e.key === "Enter") {















                e.preventDefault();















                void handleSearch();















              }















            }}















          />















        </div>















        <div className="toolbar-actions">















          <button















            className="btn btn-ghost"















            type="button"















            onClick={() => void handleSearch()}















          >















            Претражи















          </button>















          <button















            className="btn btn-ghost"















            type="button"















            onClick={() => void loadUsers()}















          >















            Освежи















          </button>















        </div>















      </div>































      <div className="table-card">















        <div className="table-scroll">















          <table className="data-table">















            <thead>















              <tr>















                <th>Корисник</th>















                <th>Име и презиме</th>















                <th>Имејл</th>















                <th>Улога</th>















                <th className="text-right">Акције</th>















              </tr>















            </thead>















            <tbody>















              {loading ? (















                <tr>















                  <td colSpan={5} className="text-center">















                    Учитавање...















                  </td>















                </tr>















              ) : users.length === 0 ? (















                <tr>















                  <td colSpan={5} className="text-center">















                    Нема корисника.















                  </td>















                </tr>















              ) : (
                users.map((u) => {
                  const rawAvatar = u.profileImage?.trim();
                  const avatarSrc =
                    rawAvatar && (rawAvatar.startsWith("http://") || rawAvatar.startsWith("https://") || rawAvatar.startsWith("data:"))
                      ? rawAvatar
                      : rawAvatar
                      ? `data:image/png;base64,${rawAvatar}`
                      : null;

                  return (
                    <tr key={u.id}>
                      <td>
                        <div className="user-cell">
                          {avatarSrc ? (
                            <img src={avatarSrc} alt={u.username} className="avatar-img small" />
                          ) : (
                            <div className="avatar small">
                              {u.username?.slice(0, 2).toUpperCase()}
                            </div>
                          )}
                          <div className="user-cell-text">
                            <div className="strong">{u.username}</div>
                            <div className="text-muted">ID: {u.id}</div>
                          </div>
                        </div>
                      </td>
                      <td>{`${u.firstName ?? ""} ${u.lastName ?? ""}`.trim() || "-"}</td>
                      <td>{u.email}</td>
                      <td>{roleBadge(u.role)}</td>
                      <td className="text-right">
                        <div className="table-actions">
                          <button className="btn btn-ghost-sm" type="button" onClick={() => handleEdit(u)}>
                            Измени
                          </button>
                          <button className="btn btn-ghost-sm danger" type="button" onClick={() => handleDelete(u.id)}>
                            Обриши
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })
)}















            </tbody>















          </table>















        </div>















      </div>































      <footer className="table-footer">















        <span className="text-muted">















          Укупно корисника: {users.length}















        </span>















      </footer>































      <UserFormModal















        isOpen={modalOpen}















        mode={editUser ? "edit" : "create"}















        initial={editUser}















        onClose={() => {















          setModalOpen(false);















          setEditUser(null);















        }}















        onSubmit={handleSubmit}















      />















    </section>















  );















};














